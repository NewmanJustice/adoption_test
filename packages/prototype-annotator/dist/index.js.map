{"version":3,"sources":["../src/db/index.ts","../src/db/repositories/annotations.ts","../src/db/repositories/events.ts","../src/services/annotation.service.ts","../src/api/annotations.routes.ts","../src/services/event.service.ts","../src/api/events.routes.ts","../src/db/repositories/prompts.ts","../src/services/prompt.service.ts","../src/api/prompts.routes.ts","../src/api/router.ts","../src/middleware/injector.ts","../src/middleware/error-handler.ts","../src/config/index.ts","../src/middleware/factory.ts"],"names":["db","path","uuidv4","Router","fs","z","exports","__filename","__dirname","expressStatic"],"mappings":"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","file":"index.js","sourcesContent":["import initSqlJs, { Database as SqlJsDatabase } from 'sql.js';\nimport fs from 'fs';\nimport path from 'path';\n\n// Wrapper to provide better-sqlite3-like API\nclass DatabaseWrapper {\n  private db: SqlJsDatabase;\n  private dbPath: string;\n  private saveTimeout: NodeJS.Timeout | null = null;\n\n  constructor(db: SqlJsDatabase, dbPath: string) {\n    this.db = db;\n    this.dbPath = dbPath;\n  }\n\n  prepare(sql: string): StatementWrapper {\n    return new StatementWrapper(this.db, sql, () => this.scheduleSave());\n  }\n\n  exec(sql: string): void {\n    this.db.run(sql);\n    this.scheduleSave();\n  }\n\n  pragma(_pragma: string): void {\n    // sql.js doesn't support WAL mode or most pragmas - silently ignore\n  }\n\n  close(): void {\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n      this.saveTimeout = null;\n    }\n    this.saveNow();\n    this.db.close();\n  }\n\n  private scheduleSave(): void {\n    // Debounce saves to avoid excessive disk writes\n    if (this.saveTimeout) {\n      clearTimeout(this.saveTimeout);\n    }\n    this.saveTimeout = setTimeout(() => {\n      this.saveNow();\n      this.saveTimeout = null;\n    }, 100);\n  }\n\n  private saveNow(): void {\n    try {\n      const data = this.db.export();\n      const buffer = Buffer.from(data);\n      fs.writeFileSync(this.dbPath, buffer);\n    } catch (error) {\n      console.error('[prototype-annotator] Failed to save database:', error);\n    }\n  }\n}\n\nclass StatementWrapper {\n  private db: SqlJsDatabase;\n  private sql: string;\n  private onWrite: () => void;\n\n  constructor(db: SqlJsDatabase, sql: string, onWrite: () => void) {\n    this.db = db;\n    this.sql = sql;\n    this.onWrite = onWrite;\n  }\n\n  run(...params: unknown[]): void {\n    this.db.run(this.sql, params as (string | number | null | Uint8Array)[]);\n    this.onWrite();\n  }\n\n  get(...params: unknown[]): Record<string, unknown> | undefined {\n    const stmt = this.db.prepare(this.sql);\n    stmt.bind(params as (string | number | null | Uint8Array)[]);\n\n    if (stmt.step()) {\n      const row = stmt.getAsObject();\n      stmt.free();\n      return row as Record<string, unknown>;\n    }\n\n    stmt.free();\n    return undefined;\n  }\n\n  all(...params: unknown[]): Record<string, unknown>[] {\n    const results: Record<string, unknown>[] = [];\n    const stmt = this.db.prepare(this.sql);\n    stmt.bind(params as (string | number | null | Uint8Array)[]);\n\n    while (stmt.step()) {\n      results.push(stmt.getAsObject() as Record<string, unknown>);\n    }\n\n    stmt.free();\n    return results;\n  }\n}\n\nlet db: DatabaseWrapper | null = null;\nlet SQL: Awaited<ReturnType<typeof initSqlJs>> | null = null;\n\n// Pre-initialize sql.js when module loads\nconst sqlJsPromise: Promise<Awaited<ReturnType<typeof initSqlJs>>> = initSqlJs();\nsqlJsPromise.then((instance) => {\n  SQL = instance;\n});\n\nexport function getDatabase(): DatabaseWrapper {\n  if (!db) {\n    throw new Error('Database not initialized. Call initDatabase() first.');\n  }\n  return db;\n}\n\nexport async function initDatabaseAsync(dbPath: string): Promise<DatabaseWrapper> {\n  // Wait for sql.js to be ready\n  if (!SQL) {\n    SQL = await sqlJsPromise;\n  }\n\n  // Ensure directory exists\n  const dir = path.dirname(dbPath);\n  if (!fs.existsSync(dir)) {\n    fs.mkdirSync(dir, { recursive: true });\n  }\n\n  // Load existing database or create new one\n  let sqlJsDb: SqlJsDatabase;\n  if (fs.existsSync(dbPath)) {\n    const fileBuffer = fs.readFileSync(dbPath);\n    sqlJsDb = new SQL.Database(fileBuffer);\n  } else {\n    sqlJsDb = new SQL.Database();\n  }\n\n  db = new DatabaseWrapper(sqlJsDb, dbPath);\n\n  // Run migrations\n  runMigrations(db);\n\n  return db;\n}\n\n// Synchronous init - requires SQL to be pre-loaded\nexport function initDatabase(dbPath: string): DatabaseWrapper {\n  if (!SQL) {\n    throw new Error(\n      'sql.js not yet initialized. Use initDatabaseAsync() or wait for module to load.'\n    );\n  }\n\n  // Ensure directory exists\n  const dir = path.dirname(dbPath);\n  if (!fs.existsSync(dir)) {\n    fs.mkdirSync(dir, { recursive: true });\n  }\n\n  // Load existing database or create new one\n  let sqlJsDb: SqlJsDatabase;\n  if (fs.existsSync(dbPath)) {\n    const fileBuffer = fs.readFileSync(dbPath);\n    sqlJsDb = new SQL.Database(fileBuffer);\n  } else {\n    sqlJsDb = new SQL.Database();\n  }\n\n  db = new DatabaseWrapper(sqlJsDb, dbPath);\n\n  // Run migrations\n  runMigrations(db);\n\n  return db;\n}\n\nexport function closeDatabase(): void {\n  if (db) {\n    db.close();\n    db = null;\n  }\n}\n\n// Export promise for consumers who need to wait\nexport function waitForSqlJs(): Promise<void> {\n  return sqlJsPromise.then(() => {});\n}\n\nfunction runMigrations(database: DatabaseWrapper): void {\n  // Create migrations tracking table\n  database.exec(`\n    CREATE TABLE IF NOT EXISTS _migrations (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      name TEXT NOT NULL UNIQUE,\n      applied_at TEXT NOT NULL\n    )\n  `);\n\n  // Migrations are inlined since they're embedded in the bundle\n  const migrations = [\n    {\n      name: '001_initial.sql',\n      sql: `\n        CREATE TABLE IF NOT EXISTS annotations (\n          id TEXT PRIMARY KEY,\n          url_full TEXT NOT NULL,\n          url_canonical TEXT NOT NULL,\n          title TEXT NOT NULL,\n          body TEXT NOT NULL,\n          anchor_type TEXT CHECK(anchor_type IN ('element', 'rect')) NOT NULL,\n          anchor_payload TEXT NOT NULL,\n          created_at TEXT NOT NULL,\n          updated_at TEXT NOT NULL,\n          deleted_at TEXT,\n          created_by TEXT NOT NULL,\n          updated_by TEXT NOT NULL\n        );\n\n        CREATE INDEX IF NOT EXISTS idx_annotations_url_canonical ON annotations(url_canonical);\n        CREATE INDEX IF NOT EXISTS idx_annotations_deleted_at ON annotations(deleted_at);\n\n        CREATE TABLE IF NOT EXISTS annotation_events (\n          id TEXT PRIMARY KEY,\n          annotation_id TEXT,\n          event_type TEXT CHECK(event_type IN ('CREATE', 'UPDATE', 'DELETE', 'RESTORE', 'EXPORT_PROMPT')) NOT NULL,\n          actor TEXT NOT NULL,\n          timestamp TEXT NOT NULL,\n          diff TEXT,\n          meta TEXT\n        );\n\n        CREATE INDEX IF NOT EXISTS idx_events_annotation_id ON annotation_events(annotation_id);\n        CREATE INDEX IF NOT EXISTS idx_events_timestamp ON annotation_events(timestamp);\n\n        CREATE TABLE IF NOT EXISTS prompt_exports (\n          id TEXT PRIMARY KEY,\n          created_at TEXT NOT NULL,\n          actor TEXT NOT NULL,\n          url_scope TEXT NOT NULL,\n          annotation_ids TEXT NOT NULL,\n          template_id TEXT NOT NULL,\n          prompt_markdown TEXT NOT NULL,\n          saved_path_md TEXT NOT NULL,\n          saved_path_json TEXT NOT NULL\n        );\n\n        CREATE INDEX IF NOT EXISTS idx_prompt_exports_created_at ON prompt_exports(created_at);\n      `,\n    },\n  ];\n\n  // Check which migrations have been applied\n  const appliedMigrations = new Set<string>();\n  const rows = database.prepare('SELECT name FROM _migrations').all() as { name: string }[];\n  for (const row of rows) {\n    appliedMigrations.add(row.name);\n  }\n\n  // Apply pending migrations\n  for (const migration of migrations) {\n    if (!appliedMigrations.has(migration.name)) {\n      database.exec(migration.sql);\n      database.prepare(\n        'INSERT INTO _migrations (name, applied_at) VALUES (?, ?)'\n      ).run(migration.name, new Date().toISOString());\n      console.log(`Applied migration: ${migration.name}`);\n    }\n  }\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { getDatabase } from '../index.js';\nimport type {\n  Annotation,\n  AnchorPayload,\n  AnchorType,\n  CreateAnnotationInput,\n  UpdateAnnotationInput,\n  PageSummary,\n} from '../../types/index.js';\n\n// Helper to extract canonical URL (strip query params and hash)\nfunction getCanonicalUrl(urlFull: string): string {\n  try {\n    const url = new URL(urlFull);\n    return `${url.origin}${url.pathname}`;\n  } catch {\n    return urlFull;\n  }\n}\n\n// Helper to parse annotation from database row\nfunction parseAnnotation(row: Record<string, unknown>): Annotation {\n  return {\n    id: row.id as string,\n    url_full: row.url_full as string,\n    url_canonical: row.url_canonical as string,\n    title: row.title as string,\n    body: row.body as string,\n    anchor_type: row.anchor_type as AnchorType,\n    anchor_payload: JSON.parse(row.anchor_payload as string) as AnchorPayload,\n    created_at: row.created_at as string,\n    updated_at: row.updated_at as string,\n    deleted_at: row.deleted_at as string | null,\n    created_by: row.created_by as string,\n    updated_by: row.updated_by as string,\n  };\n}\n\nexport class AnnotationRepository {\n  create(input: CreateAnnotationInput): Annotation {\n    const db = getDatabase();\n    const id = uuidv4();\n    const now = new Date().toISOString();\n    const urlCanonical = getCanonicalUrl(input.url_full);\n\n    const stmt = db.prepare(`\n      INSERT INTO annotations (\n        id, url_full, url_canonical, title, body, anchor_type, anchor_payload,\n        created_at, updated_at, deleted_at, created_by, updated_by\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, NULL, ?, ?)\n    `);\n\n    stmt.run(\n      id,\n      input.url_full,\n      urlCanonical,\n      input.title,\n      input.body,\n      input.anchor_type,\n      JSON.stringify(input.anchor_payload),\n      now,\n      now,\n      input.actor,\n      input.actor\n    );\n\n    return this.findById(id)!;\n  }\n\n  findById(id: string): Annotation | null {\n    const db = getDatabase();\n    const row = db.prepare('SELECT * FROM annotations WHERE id = ?').get(id) as Record<string, unknown> | undefined;\n    return row ? parseAnnotation(row) : null;\n  }\n\n  findByUrl(urlCanonical: string, includeDeleted = false): Annotation[] {\n    const db = getDatabase();\n    const query = includeDeleted\n      ? 'SELECT * FROM annotations WHERE url_canonical = ? ORDER BY created_at DESC'\n      : 'SELECT * FROM annotations WHERE url_canonical = ? AND deleted_at IS NULL ORDER BY created_at DESC';\n\n    const rows = db.prepare(query).all(urlCanonical) as Record<string, unknown>[];\n    return rows.map(parseAnnotation);\n  }\n\n  findAll(includeDeleted = false): Annotation[] {\n    const db = getDatabase();\n    const query = includeDeleted\n      ? 'SELECT * FROM annotations ORDER BY created_at DESC'\n      : 'SELECT * FROM annotations WHERE deleted_at IS NULL ORDER BY created_at DESC';\n\n    const rows = db.prepare(query).all() as Record<string, unknown>[];\n    return rows.map(parseAnnotation);\n  }\n\n  findByIds(ids: string[]): Annotation[] {\n    if (ids.length === 0) return [];\n\n    const db = getDatabase();\n    const placeholders = ids.map(() => '?').join(',');\n    const rows = db.prepare(\n      `SELECT * FROM annotations WHERE id IN (${placeholders}) AND deleted_at IS NULL`\n    ).all(...ids) as Record<string, unknown>[];\n\n    return rows.map(parseAnnotation);\n  }\n\n  update(id: string, input: UpdateAnnotationInput): Annotation | null {\n    const db = getDatabase();\n    const existing = this.findById(id);\n    if (!existing || existing.deleted_at) return null;\n\n    const now = new Date().toISOString();\n    const updates: string[] = ['updated_at = ?', 'updated_by = ?'];\n    const values: unknown[] = [now, input.actor];\n\n    if (input.title !== undefined) {\n      updates.push('title = ?');\n      values.push(input.title);\n    }\n    if (input.body !== undefined) {\n      updates.push('body = ?');\n      values.push(input.body);\n    }\n    if (input.anchor_type !== undefined) {\n      updates.push('anchor_type = ?');\n      values.push(input.anchor_type);\n    }\n    if (input.anchor_payload !== undefined) {\n      updates.push('anchor_payload = ?');\n      values.push(JSON.stringify(input.anchor_payload));\n    }\n\n    values.push(id);\n\n    db.prepare(`UPDATE annotations SET ${updates.join(', ')} WHERE id = ?`).run(...values);\n\n    return this.findById(id);\n  }\n\n  softDelete(id: string, actor: string): Annotation | null {\n    const db = getDatabase();\n    const existing = this.findById(id);\n    if (!existing || existing.deleted_at) return null;\n\n    const now = new Date().toISOString();\n    db.prepare('UPDATE annotations SET deleted_at = ?, updated_at = ?, updated_by = ? WHERE id = ?')\n      .run(now, now, actor, id);\n\n    return this.findById(id);\n  }\n\n  restore(id: string, actor: string): Annotation | null {\n    const db = getDatabase();\n    const row = db.prepare('SELECT * FROM annotations WHERE id = ?').get(id) as Record<string, unknown> | undefined;\n    if (!row || !row.deleted_at) return null;\n\n    const now = new Date().toISOString();\n    db.prepare('UPDATE annotations SET deleted_at = NULL, updated_at = ?, updated_by = ? WHERE id = ?')\n      .run(now, actor, id);\n\n    return this.findById(id);\n  }\n\n  getPages(): PageSummary[] {\n    const db = getDatabase();\n    const rows = db.prepare(`\n      SELECT\n        url_canonical,\n        COUNT(*) as annotation_count,\n        MAX(updated_at) as latest_annotation_at\n      FROM annotations\n      WHERE deleted_at IS NULL\n      GROUP BY url_canonical\n      ORDER BY latest_annotation_at DESC\n    `).all() as { url_canonical: string; annotation_count: number; latest_annotation_at: string }[];\n\n    return rows;\n  }\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { getDatabase } from '../index.js';\nimport type { AnnotationEvent, EventType } from '../../types/index.js';\n\n// Helper to parse event from database row\nfunction parseEvent(row: Record<string, unknown>): AnnotationEvent {\n  return {\n    id: row.id as string,\n    annotation_id: row.annotation_id as string | null,\n    event_type: row.event_type as EventType,\n    actor: row.actor as string,\n    timestamp: row.timestamp as string,\n    diff: row.diff ? JSON.parse(row.diff as string) : null,\n    meta: row.meta ? JSON.parse(row.meta as string) : null,\n  };\n}\n\nexport class EventRepository {\n  create(input: {\n    annotation_id?: string | null;\n    event_type: EventType;\n    actor: string;\n    diff?: Record<string, { old: unknown; new: unknown }> | null;\n    meta?: Record<string, unknown> | null;\n  }): AnnotationEvent {\n    const db = getDatabase();\n    const id = uuidv4();\n    const timestamp = new Date().toISOString();\n\n    const stmt = db.prepare(`\n      INSERT INTO annotation_events (id, annotation_id, event_type, actor, timestamp, diff, meta)\n      VALUES (?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    stmt.run(\n      id,\n      input.annotation_id ?? null,\n      input.event_type,\n      input.actor,\n      timestamp,\n      input.diff ? JSON.stringify(input.diff) : null,\n      input.meta ? JSON.stringify(input.meta) : null\n    );\n\n    return this.findById(id)!;\n  }\n\n  findById(id: string): AnnotationEvent | null {\n    const db = getDatabase();\n    const row = db.prepare('SELECT * FROM annotation_events WHERE id = ?').get(id) as Record<string, unknown> | undefined;\n    return row ? parseEvent(row) : null;\n  }\n\n  findByAnnotationId(annotationId: string): AnnotationEvent[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM annotation_events WHERE annotation_id = ? ORDER BY timestamp DESC'\n    ).all(annotationId) as Record<string, unknown>[];\n    return rows.map(parseEvent);\n  }\n\n  findAll(limit = 100, offset = 0): AnnotationEvent[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM annotation_events ORDER BY timestamp DESC LIMIT ? OFFSET ?'\n    ).all(limit, offset) as Record<string, unknown>[];\n    return rows.map(parseEvent);\n  }\n\n  findByEventType(eventType: EventType, limit = 100): AnnotationEvent[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM annotation_events WHERE event_type = ? ORDER BY timestamp DESC LIMIT ?'\n    ).all(eventType, limit) as Record<string, unknown>[];\n    return rows.map(parseEvent);\n  }\n\n  countAll(): number {\n    const db = getDatabase();\n    const result = db.prepare('SELECT COUNT(*) as count FROM annotation_events').get() as { count: number };\n    return result.count;\n  }\n\n  findByDateRange(startDate: string, endDate: string): AnnotationEvent[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM annotation_events WHERE timestamp >= ? AND timestamp <= ? ORDER BY timestamp DESC'\n    ).all(startDate, endDate) as Record<string, unknown>[];\n    return rows.map(parseEvent);\n  }\n\n  findByUrlCanonical(urlCanonical: string, limit = 100): AnnotationEvent[] {\n    const db = getDatabase();\n    const rows = db.prepare(`\n      SELECT e.* FROM annotation_events e\n      INNER JOIN annotations a ON e.annotation_id = a.id\n      WHERE a.url_canonical = ?\n      ORDER BY e.timestamp DESC\n      LIMIT ?\n    `).all(urlCanonical, limit) as Record<string, unknown>[];\n    return rows.map(parseEvent);\n  }\n}\n","import { AnnotationRepository } from '../db/repositories/annotations.js';\nimport { EventRepository } from '../db/repositories/events.js';\nimport type {\n  Annotation,\n  CreateAnnotationInput,\n  UpdateAnnotationInput,\n  PageSummary,\n} from '../types/index.js';\n\nexport class AnnotationService {\n  private annotationRepo: AnnotationRepository;\n  private eventRepo: EventRepository;\n\n  constructor() {\n    this.annotationRepo = new AnnotationRepository();\n    this.eventRepo = new EventRepository();\n  }\n\n  create(input: CreateAnnotationInput): Annotation {\n    const annotation = this.annotationRepo.create(input);\n\n    // Log creation event\n    this.eventRepo.create({\n      annotation_id: annotation.id,\n      event_type: 'CREATE',\n      actor: input.actor,\n      meta: {\n        url_full: annotation.url_full,\n        title: annotation.title,\n      },\n    });\n\n    return annotation;\n  }\n\n  findById(id: string): Annotation | null {\n    return this.annotationRepo.findById(id);\n  }\n\n  findByUrl(urlCanonical: string, includeDeleted = false): Annotation[] {\n    return this.annotationRepo.findByUrl(urlCanonical, includeDeleted);\n  }\n\n  findAll(includeDeleted = false): Annotation[] {\n    return this.annotationRepo.findAll(includeDeleted);\n  }\n\n  findByIds(ids: string[]): Annotation[] {\n    return this.annotationRepo.findByIds(ids);\n  }\n\n  update(id: string, input: UpdateAnnotationInput): Annotation | null {\n    const existing = this.annotationRepo.findById(id);\n    if (!existing || existing.deleted_at) return null;\n\n    // Build diff for event logging\n    const diff: Record<string, { old: unknown; new: unknown }> = {};\n\n    if (input.title !== undefined && input.title !== existing.title) {\n      diff.title = { old: existing.title, new: input.title };\n    }\n    if (input.body !== undefined && input.body !== existing.body) {\n      diff.body = { old: existing.body, new: input.body };\n    }\n    if (input.anchor_type !== undefined && input.anchor_type !== existing.anchor_type) {\n      diff.anchor_type = { old: existing.anchor_type, new: input.anchor_type };\n    }\n    if (input.anchor_payload !== undefined) {\n      diff.anchor_payload = { old: existing.anchor_payload, new: input.anchor_payload };\n    }\n\n    const updated = this.annotationRepo.update(id, input);\n    if (!updated) return null;\n\n    // Log update event if there were changes\n    if (Object.keys(diff).length > 0) {\n      this.eventRepo.create({\n        annotation_id: id,\n        event_type: 'UPDATE',\n        actor: input.actor,\n        diff,\n      });\n    }\n\n    return updated;\n  }\n\n  delete(id: string, actor: string): Annotation | null {\n    const deleted = this.annotationRepo.softDelete(id, actor);\n    if (!deleted) return null;\n\n    // Log delete event\n    this.eventRepo.create({\n      annotation_id: id,\n      event_type: 'DELETE',\n      actor,\n      meta: {\n        title: deleted.title,\n        url_canonical: deleted.url_canonical,\n      },\n    });\n\n    return deleted;\n  }\n\n  restore(id: string, actor: string): Annotation | null {\n    const restored = this.annotationRepo.restore(id, actor);\n    if (!restored) return null;\n\n    // Log restore event\n    this.eventRepo.create({\n      annotation_id: id,\n      event_type: 'RESTORE',\n      actor,\n    });\n\n    return restored;\n  }\n\n  getPages(): PageSummary[] {\n    return this.annotationRepo.getPages();\n  }\n}\n","import { Router, Request, Response } from 'express';\nimport { z } from 'zod';\nimport { AnnotationService } from '../services/annotation.service.js';\nimport type { ResolvedConfig } from '../types/index.js';\n\nconst CreateAnnotationSchema = z.object({\n  url_full: z.string().url(),\n  title: z.string().min(1).max(500),\n  body: z.string(),\n  anchor_type: z.enum(['element', 'rect']),\n  anchor_payload: z.record(z.unknown()),\n  actor: z.string().optional(),\n});\n\nconst UpdateAnnotationSchema = z.object({\n  title: z.string().min(1).max(500).optional(),\n  body: z.string().optional(),\n  anchor_type: z.enum(['element', 'rect']).optional(),\n  anchor_payload: z.record(z.unknown()).optional(),\n  actor: z.string().optional(),\n});\n\nexport function createAnnotationsRouter(config: ResolvedConfig): Router {\n  const router = Router();\n  const service = new AnnotationService();\n\n  // List all annotations\n  router.get('/', (_req: Request, res: Response) => {\n    try {\n      const includeDeleted = _req.query.includeDeleted === 'true';\n      const annotations = service.findAll(includeDeleted);\n      res.json({ success: true, data: annotations });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get annotations by URL\n  router.get('/by-url', (req: Request, res: Response) => {\n    try {\n      const url = req.query.url as string;\n      if (!url) {\n        res.status(400).json({ success: false, error: 'url query parameter required' });\n        return;\n      }\n      const includeDeleted = req.query.includeDeleted === 'true';\n      const annotations = service.findByUrl(url, includeDeleted);\n      res.json({ success: true, data: annotations });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get single annotation\n  router.get('/:id', (req: Request, res: Response) => {\n    try {\n      const annotation = service.findById(req.params.id);\n      if (!annotation) {\n        res.status(404).json({ success: false, error: 'Annotation not found' });\n        return;\n      }\n      res.json({ success: true, data: annotation });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Create annotation\n  router.post('/', (req: Request, res: Response) => {\n    try {\n      const result = CreateAnnotationSchema.safeParse(req.body);\n      if (!result.success) {\n        res.status(400).json({ success: false, error: result.error.message });\n        return;\n      }\n\n      const annotation = service.create({\n        ...result.data,\n        anchor_payload: result.data.anchor_payload as never,\n        actor: result.data.actor || config.defaultActor,\n      });\n\n      res.status(201).json({ success: true, data: annotation });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Update annotation\n  router.patch('/:id', (req: Request, res: Response) => {\n    try {\n      const result = UpdateAnnotationSchema.safeParse(req.body);\n      if (!result.success) {\n        res.status(400).json({ success: false, error: result.error.message });\n        return;\n      }\n\n      const updated = service.update(req.params.id, {\n        ...result.data,\n        anchor_payload: result.data.anchor_payload as never,\n        actor: result.data.actor || config.defaultActor,\n      });\n\n      if (!updated) {\n        res.status(404).json({ success: false, error: 'Annotation not found' });\n        return;\n      }\n\n      res.json({ success: true, data: updated });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Delete annotation (soft delete)\n  router.delete('/:id', (req: Request, res: Response) => {\n    try {\n      const actor = (req.query.actor as string) || config.defaultActor;\n      const deleted = service.delete(req.params.id, actor);\n\n      if (!deleted) {\n        res.status(404).json({ success: false, error: 'Annotation not found' });\n        return;\n      }\n\n      res.json({ success: true, data: deleted });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Restore annotation\n  router.post('/:id/restore', (req: Request, res: Response) => {\n    try {\n      const actor = (req.body.actor as string) || config.defaultActor;\n      const restored = service.restore(req.params.id, actor);\n\n      if (!restored) {\n        res.status(404).json({ success: false, error: 'Annotation not found or not deleted' });\n        return;\n      }\n\n      res.json({ success: true, data: restored });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  return router;\n}\n","import { EventRepository } from '../db/repositories/events.js';\nimport type { AnnotationEvent, EventType } from '../types/index.js';\n\nexport class EventService {\n  private eventRepo: EventRepository;\n\n  constructor() {\n    this.eventRepo = new EventRepository();\n  }\n\n  findById(id: string): AnnotationEvent | null {\n    return this.eventRepo.findById(id);\n  }\n\n  findByAnnotationId(annotationId: string): AnnotationEvent[] {\n    return this.eventRepo.findByAnnotationId(annotationId);\n  }\n\n  findAll(limit = 100, offset = 0): AnnotationEvent[] {\n    return this.eventRepo.findAll(limit, offset);\n  }\n\n  findByEventType(eventType: EventType, limit = 100): AnnotationEvent[] {\n    return this.eventRepo.findByEventType(eventType, limit);\n  }\n\n  findByDateRange(startDate: string, endDate: string): AnnotationEvent[] {\n    return this.eventRepo.findByDateRange(startDate, endDate);\n  }\n\n  countAll(): number {\n    return this.eventRepo.countAll();\n  }\n\n  getRecentActivity(limit = 20): AnnotationEvent[] {\n    return this.eventRepo.findAll(limit, 0);\n  }\n\n  findByUrlCanonical(urlCanonical: string, limit = 100): AnnotationEvent[] {\n    return this.eventRepo.findByUrlCanonical(urlCanonical, limit);\n  }\n}\n","import { Router, Request, Response } from 'express';\nimport { EventService } from '../services/event.service.js';\n\nexport function createEventsRouter(): Router {\n  const router = Router();\n  const service = new EventService();\n\n  // List events with optional filters\n  router.get('/', (req: Request, res: Response) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 100, 500);\n      const offset = parseInt(req.query.offset as string) || 0;\n      const annotationId = req.query.annotationId as string | undefined;\n      const urlCanonical = req.query.url_canonical as string | undefined;\n\n      let events;\n      let total;\n\n      if (annotationId) {\n        // Filter by annotation ID\n        events = service.findByAnnotationId(annotationId);\n        total = events.length;\n      } else if (urlCanonical) {\n        // Filter by URL canonical\n        events = service.findByUrlCanonical(urlCanonical, limit);\n        total = events.length;\n      } else {\n        // Get all events with pagination\n        events = service.findAll(limit, offset);\n        total = service.countAll();\n      }\n\n      res.json({\n        success: true,\n        data: {\n          items: events,\n          total,\n          limit,\n          offset,\n        },\n      });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get events by annotation ID (explicit route)\n  router.get('/by-annotation/:annotationId', (req: Request, res: Response) => {\n    try {\n      const events = service.findByAnnotationId(req.params.annotationId);\n      res.json({ success: true, data: events });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get events by type\n  router.get('/by-type/:eventType', (req: Request, res: Response) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 100, 500);\n      const eventType = req.params.eventType.toUpperCase() as 'CREATE' | 'UPDATE' | 'DELETE' | 'RESTORE' | 'EXPORT_PROMPT';\n\n      const validTypes = ['CREATE', 'UPDATE', 'DELETE', 'RESTORE', 'EXPORT_PROMPT'];\n      if (!validTypes.includes(eventType)) {\n        res.status(400).json({ success: false, error: 'Invalid event type' });\n        return;\n      }\n\n      const events = service.findByEventType(eventType, limit);\n      res.json({ success: true, data: events });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get single event\n  router.get('/:id', (req: Request, res: Response) => {\n    try {\n      const event = service.findById(req.params.id);\n      if (!event) {\n        res.status(404).json({ success: false, error: 'Event not found' });\n        return;\n      }\n      res.json({ success: true, data: event });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get recent activity\n  router.get('/recent/activity', (req: Request, res: Response) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);\n      const events = service.getRecentActivity(limit);\n      res.json({ success: true, data: events });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  return router;\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { getDatabase } from '../index.js';\nimport type { PromptExport } from '../../types/index.js';\n\n// Helper to parse prompt export from database row\nfunction parsePromptExport(row: Record<string, unknown>): PromptExport {\n  return {\n    id: row.id as string,\n    created_at: row.created_at as string,\n    actor: row.actor as string,\n    url_scope: JSON.parse(row.url_scope as string),\n    annotation_ids: JSON.parse(row.annotation_ids as string),\n    template_id: row.template_id as string,\n    prompt_markdown: row.prompt_markdown as string,\n    saved_path_md: row.saved_path_md as string,\n    saved_path_json: row.saved_path_json as string,\n  };\n}\n\nexport class PromptExportRepository {\n  create(input: {\n    actor: string;\n    url_scope: string[];\n    annotation_ids: string[];\n    template_id: string;\n    prompt_markdown: string;\n    saved_path_md: string;\n    saved_path_json: string;\n  }): PromptExport {\n    const db = getDatabase();\n    const id = uuidv4();\n    const createdAt = new Date().toISOString();\n\n    const stmt = db.prepare(`\n      INSERT INTO prompt_exports (\n        id, created_at, actor, url_scope, annotation_ids, template_id,\n        prompt_markdown, saved_path_md, saved_path_json\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\n    `);\n\n    stmt.run(\n      id,\n      createdAt,\n      input.actor,\n      JSON.stringify(input.url_scope),\n      JSON.stringify(input.annotation_ids),\n      input.template_id,\n      input.prompt_markdown,\n      input.saved_path_md,\n      input.saved_path_json\n    );\n\n    return this.findById(id)!;\n  }\n\n  findById(id: string): PromptExport | null {\n    const db = getDatabase();\n    const row = db.prepare('SELECT * FROM prompt_exports WHERE id = ?').get(id) as Record<string, unknown> | undefined;\n    return row ? parsePromptExport(row) : null;\n  }\n\n  findAll(limit = 50, offset = 0): PromptExport[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM prompt_exports ORDER BY created_at DESC LIMIT ? OFFSET ?'\n    ).all(limit, offset) as Record<string, unknown>[];\n    return rows.map(parsePromptExport);\n  }\n\n  findByActor(actor: string): PromptExport[] {\n    const db = getDatabase();\n    const rows = db.prepare(\n      'SELECT * FROM prompt_exports WHERE actor = ? ORDER BY created_at DESC'\n    ).all(actor) as Record<string, unknown>[];\n    return rows.map(parsePromptExport);\n  }\n\n  countAll(): number {\n    const db = getDatabase();\n    const result = db.prepare('SELECT COUNT(*) as count FROM prompt_exports').get() as { count: number };\n    return result.count;\n  }\n}\n","import fs from 'fs';\nimport path from 'path';\nimport { AnnotationRepository } from '../db/repositories/annotations.js';\nimport { PromptExportRepository } from '../db/repositories/prompts.js';\nimport { EventRepository } from '../db/repositories/events.js';\nimport type {\n  Annotation,\n  ElementAnchor,\n  GeneratePromptInput,\n  GeneratedPrompt,\n  PromptExport,\n  ResolvedConfig,\n} from '../types/index.js';\n\nconst AGENTIC_DEV_TEMPLATE = `# Implementation Prompt\n\n## Context\n\nThis document contains feedback and annotations collected from a prototype review session. The annotations describe required changes, observations, and suggestions for improvement.\n\n## Screens in Scope\n\n{{screens_section}}\n\n## Observations\n\n{{observations_section}}\n\n## Required Changes\n\n{{changes_section}}\n\n## Acceptance Criteria\n\n{{acceptance_section}}\n\n## Suggested Tests / Checks\n\n{{tests_section}}\n\n## Assumptions & Out of Scope\n\n- Authentication and authorization are not in scope for this change\n- Performance optimization is not required unless explicitly mentioned\n- Backwards compatibility should be maintained where possible\n\n---\n\n**Generated:** {{generated_at}}\n**Annotations included:** {{annotation_count}}\n**Template:** agentic-dev\n\n*Generated by prototype-annotator*\n`;\n\nexport class PromptService {\n  private annotationRepo: AnnotationRepository;\n  private promptRepo: PromptExportRepository;\n  private eventRepo: EventRepository;\n  private config: ResolvedConfig;\n\n  constructor(config: ResolvedConfig) {\n    this.annotationRepo = new AnnotationRepository();\n    this.promptRepo = new PromptExportRepository();\n    this.eventRepo = new EventRepository();\n    this.config = config;\n  }\n\n  async generate(input: GeneratePromptInput): Promise<GeneratedPrompt> {\n    // Get annotations by URLs or specific IDs\n    let annotations: Annotation[] = [];\n\n    if (input.annotation_ids && input.annotation_ids.length > 0) {\n      annotations = this.annotationRepo.findByIds(input.annotation_ids);\n    } else if (input.urls && input.urls.length > 0) {\n      for (const url of input.urls) {\n        const urlAnnotations = this.annotationRepo.findByUrl(url);\n        annotations.push(...urlAnnotations);\n      }\n    } else {\n      annotations = this.annotationRepo.findAll();\n    }\n\n    // Generate markdown from template\n    const markdown = this.generateMarkdown(annotations);\n\n    return {\n      markdown,\n      annotations,\n      enhanced: false,\n    };\n  }\n\n  async confirm(input: GeneratePromptInput & { markdown?: string }): Promise<PromptExport> {\n    // If markdown is provided, use it directly (user may have edited it)\n    let markdown = input.markdown;\n    let annotations: Annotation[] = [];\n\n    if (!markdown) {\n      const generated = await this.generate(input);\n      markdown = generated.markdown;\n      annotations = generated.annotations;\n    } else {\n      // Get annotations for metadata\n      if (input.annotation_ids && input.annotation_ids.length > 0) {\n        annotations = this.annotationRepo.findByIds(input.annotation_ids);\n      } else if (input.urls && input.urls.length > 0) {\n        for (const url of input.urls) {\n          const urlAnnotations = this.annotationRepo.findByUrl(url);\n          annotations.push(...urlAnnotations);\n        }\n      }\n    }\n\n    // Ensure export directory exists\n    if (!fs.existsSync(this.config.exportDir)) {\n      fs.mkdirSync(this.config.exportDir, { recursive: true });\n    }\n\n    // Generate filenames with proper format: YYYY-MM-DD__HHmm__<slug>.md\n    const now = new Date();\n    const dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD\n    const timeStr = now.toISOString().slice(11, 16).replace(':', ''); // HHmm\n    const slug = this.generateSlug(annotations);\n    const baseFilename = `${dateStr}__${timeStr}__${slug}`;\n    const mdPath = path.join(this.config.exportDir, `${baseFilename}.md`);\n    const jsonPath = path.join(this.config.exportDir, `${baseFilename}.json`);\n\n    // Write markdown file\n    fs.writeFileSync(mdPath, markdown, 'utf-8');\n\n    // Write JSON file with metadata\n    const jsonContent = {\n      generated_at: now.toISOString(),\n      actor: input.actor,\n      urls: input.urls || [...new Set(annotations.map(a => a.url_full))],\n      annotation_ids: annotations.map((a) => a.id),\n      template_id: input.template_id || 'agentic-dev',\n      prompt_markdown: markdown,\n      annotations: annotations,\n    };\n    fs.writeFileSync(jsonPath, JSON.stringify(jsonContent, null, 2), 'utf-8');\n\n    // Save to database\n    const promptExport = this.promptRepo.create({\n      actor: input.actor,\n      url_scope: input.urls || [...new Set(annotations.map(a => a.url_full))],\n      annotation_ids: annotations.map((a) => a.id),\n      template_id: input.template_id || 'agentic-dev',\n      prompt_markdown: markdown,\n      saved_path_md: mdPath,\n      saved_path_json: jsonPath,\n    });\n\n    // Log export event\n    this.eventRepo.create({\n      annotation_id: null,\n      event_type: 'EXPORT_PROMPT',\n      actor: input.actor,\n      meta: {\n        export_id: promptExport.id,\n        annotation_count: annotations.length,\n        paths: { md: mdPath, json: jsonPath },\n      },\n    });\n\n    return promptExport;\n  }\n\n  // Keep export as alias for confirm for backwards compatibility\n  async export(input: GeneratePromptInput): Promise<PromptExport> {\n    return this.confirm(input);\n  }\n\n  findExportById(id: string): PromptExport | null {\n    return this.promptRepo.findById(id);\n  }\n\n  findAllExports(limit = 50, offset = 0): PromptExport[] {\n    return this.promptRepo.findAll(limit, offset);\n  }\n\n  private generateSlug(annotations: Annotation[]): string {\n    if (annotations.length === 0) return 'empty';\n\n    // Use first annotation title to generate slug\n    const title = annotations[0].title;\n    return title\n      .toLowerCase()\n      .replace(/[^a-z0-9]+/g, '-')\n      .replace(/^-|-$/g, '')\n      .slice(0, 30) || 'annotations';\n  }\n\n  private formatElementLocation(annotation: Annotation): string {\n    if (annotation.anchor_type === 'element') {\n      const anchor = annotation.anchor_payload as ElementAnchor;\n      const parts: string[] = [];\n\n      if (anchor.selector) {\n        parts.push(`Selector: \\`${anchor.selector}\\``);\n      }\n      if (anchor.textContent) {\n        // Truncate long text content\n        const text = anchor.textContent.length > 100\n          ? anchor.textContent.slice(0, 100) + '...'\n          : anchor.textContent;\n        parts.push(`Text: \"${text}\"`);\n      }\n\n      return parts.join(' | ');\n    } else {\n      // Rectangle selection - just note it's a region\n      return 'Region selection (coordinates captured)';\n    }\n  }\n\n  private generateMarkdown(annotations: Annotation[]): string {\n    const now = new Date().toISOString();\n\n    // Group annotations by URL\n    const byUrl = new Map<string, Annotation[]>();\n    for (const annotation of annotations) {\n      const url = annotation.url_full;\n      if (!byUrl.has(url)) {\n        byUrl.set(url, []);\n      }\n      byUrl.get(url)!.push(annotation);\n    }\n\n    // Generate screens section\n    const screensSection = Array.from(byUrl.keys())\n      .map(url => `- ${url}`)\n      .join('\\n') || '- No screens specified';\n\n    // Generate observations section (grouped by screen)\n    let observationsSection = '';\n    for (const [url, urlAnnotations] of byUrl) {\n      observationsSection += `### ${new URL(url).pathname}\\n\\n`;\n      for (const a of urlAnnotations) {\n        observationsSection += `- **${a.title}**\\n`;\n        observationsSection += `  - Element: ${this.formatElementLocation(a)}\\n`;\n        if (a.body) {\n          observationsSection += `  - Note: ${a.body}\\n`;\n        }\n        observationsSection += '\\n';\n      }\n    }\n    observationsSection = observationsSection.trim() || 'No observations recorded.';\n\n    // Generate required changes section\n    let changesSection = '';\n    let changeNum = 1;\n    for (const annotation of annotations) {\n      changesSection += `${changeNum}. **${annotation.title}**\\n`;\n      if (annotation.body) {\n        changesSection += `   - ${annotation.body}\\n`;\n      }\n      changesSection += `   - Element: ${this.formatElementLocation(annotation)}\\n`;\n      changesSection += `   - Page: ${annotation.url_canonical}\\n\\n`;\n      changeNum++;\n    }\n    changesSection = changesSection.trim() || 'No changes specified.';\n\n    // Generate acceptance criteria\n    let acceptanceSection = '';\n    for (const annotation of annotations) {\n      acceptanceSection += `- [ ] ${annotation.title} has been implemented\\n`;\n    }\n    acceptanceSection = acceptanceSection.trim() || '- [ ] All changes have been reviewed and approved';\n\n    // Generate tests section\n    let testsSection = '';\n    for (const annotation of annotations) {\n      testsSection += `- [ ] Verify: ${annotation.title}\\n`;\n    }\n    testsSection += '- [ ] Visual regression test passes\\n';\n    testsSection += '- [ ] No console errors in browser\\n';\n    testsSection = testsSection.trim();\n\n    // Replace template placeholders\n    let output = AGENTIC_DEV_TEMPLATE;\n    output = output.replace('{{screens_section}}', screensSection);\n    output = output.replace('{{observations_section}}', observationsSection);\n    output = output.replace('{{changes_section}}', changesSection);\n    output = output.replace('{{acceptance_section}}', acceptanceSection);\n    output = output.replace('{{tests_section}}', testsSection);\n    output = output.replace('{{generated_at}}', now);\n    output = output.replace('{{annotation_count}}', String(annotations.length));\n\n    return output;\n  }\n}\n","import { Router, Request, Response } from 'express';\nimport { z } from 'zod';\nimport { PromptService } from '../services/prompt.service.js';\nimport type { ResolvedConfig } from '../types/index.js';\n\nconst GeneratePromptSchema = z.object({\n  urls: z.array(z.string()).optional(),\n  annotation_ids: z.array(z.string()).optional(),\n  template_id: z.string().optional(),\n  enhance_with_ai: z.boolean().optional(),\n  actor: z.string().optional(),\n});\n\nconst ConfirmPromptSchema = z.object({\n  urls: z.array(z.string()).optional(),\n  annotation_ids: z.array(z.string()).optional(),\n  template_id: z.string().optional(),\n  markdown: z.string().optional(),\n  actor: z.string().optional(),\n});\n\nexport function createPromptsRouter(config: ResolvedConfig): Router {\n  const router = Router();\n  const service = new PromptService(config);\n\n  // Generate prompt (preview without saving)\n  router.post('/generate', async (req: Request, res: Response) => {\n    try {\n      const result = GeneratePromptSchema.safeParse(req.body);\n      if (!result.success) {\n        res.status(400).json({ success: false, error: result.error.message });\n        return;\n      }\n\n      const generated = await service.generate({\n        ...result.data,\n        actor: result.data.actor || config.defaultActor,\n      });\n\n      res.json({ success: true, data: generated });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Confirm prompt (save to files) - new endpoint per spec\n  router.post('/confirm', async (req: Request, res: Response) => {\n    try {\n      const result = ConfirmPromptSchema.safeParse(req.body);\n      if (!result.success) {\n        res.status(400).json({ success: false, error: result.error.message });\n        return;\n      }\n\n      const exported = await service.confirm({\n        ...result.data,\n        actor: result.data.actor || config.defaultActor,\n      });\n\n      res.status(201).json({ success: true, data: exported });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Export prompt (alias for confirm, for backwards compatibility)\n  router.post('/export', async (req: Request, res: Response) => {\n    try {\n      const result = ConfirmPromptSchema.safeParse(req.body);\n      if (!result.success) {\n        res.status(400).json({ success: false, error: result.error.message });\n        return;\n      }\n\n      const exported = await service.confirm({\n        ...result.data,\n        actor: result.data.actor || config.defaultActor,\n      });\n\n      res.status(201).json({ success: true, data: exported });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // List all exports\n  router.get('/exports', (req: Request, res: Response) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 50, 200);\n      const offset = parseInt(req.query.offset as string) || 0;\n\n      const exports = service.findAllExports(limit, offset);\n      res.json({ success: true, data: exports });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Get single export\n  router.get('/exports/:id', (req: Request, res: Response) => {\n    try {\n      const exported = service.findExportById(req.params.id);\n      if (!exported) {\n        res.status(404).json({ success: false, error: 'Export not found' });\n        return;\n      }\n      res.json({ success: true, data: exported });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  return router;\n}\n","import { Router } from 'express';\nimport { createAnnotationsRouter } from './annotations.routes.js';\nimport { createEventsRouter } from './events.routes.js';\nimport { createPromptsRouter } from './prompts.routes.js';\nimport { AnnotationService } from '../services/annotation.service.js';\nimport type { ResolvedConfig } from '../types/index.js';\n\nexport function createApiRouter(config: ResolvedConfig): Router {\n  const router = Router();\n  const annotationService = new AnnotationService();\n\n  // Mount sub-routers\n  router.use('/annotations', createAnnotationsRouter(config));\n  router.use('/events', createEventsRouter());\n  router.use('/prompts', createPromptsRouter(config));\n\n  // Pages endpoint (list all annotated URLs)\n  router.get('/pages', (_req, res) => {\n    try {\n      const pages = annotationService.getPages();\n      res.json({ success: true, data: pages });\n    } catch (error) {\n      res.status(500).json({ success: false, error: String(error) });\n    }\n  });\n\n  // Health check\n  router.get('/health', (_req, res) => {\n    res.json({\n      success: true,\n      data: {\n        status: 'ok',\n        timestamp: new Date().toISOString(),\n      },\n    });\n  });\n\n  return router;\n}\n","import type { Request, Response, NextFunction } from 'express';\nimport type { ClientConfig } from '../types/index.js';\n\nexport function createInjector(basePath: string, clientConfig: ClientConfig) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    // Skip API and static asset requests\n    if (req.path.startsWith(basePath)) {\n      next();\n      return;\n    }\n\n    // Store original methods\n    const originalWrite = res.write.bind(res);\n    const originalEnd = res.end.bind(res);\n\n    let chunks: Buffer[] = [];\n    let isHtml = false;\n\n    // Override write to capture chunks\n    res.write = function (\n      chunk: unknown,\n      encodingOrCallback?: BufferEncoding | ((error: Error | null | undefined) => void),\n      callback?: (error: Error | null | undefined) => void\n    ): boolean {\n      const encoding = typeof encodingOrCallback === 'function' ? undefined : encodingOrCallback;\n      const cb = typeof encodingOrCallback === 'function' ? encodingOrCallback : callback;\n\n      if (chunk) {\n        if (Buffer.isBuffer(chunk)) {\n          chunks.push(chunk);\n        } else if (typeof chunk === 'string') {\n          chunks.push(Buffer.from(chunk, encoding || 'utf-8'));\n        }\n      }\n\n      // Check content type on first write\n      if (chunks.length === 1) {\n        const contentType = res.getHeader('content-type');\n        isHtml = typeof contentType === 'string' && contentType.includes('text/html');\n      }\n\n      if (cb) {\n        cb(null);\n      }\n      return true;\n    };\n\n    // Override end to inject script\n    res.end = function (\n      chunk?: unknown,\n      encodingOrCallback?: BufferEncoding | (() => void),\n      callback?: () => void\n    ): Response {\n      const encoding = typeof encodingOrCallback === 'function' ? undefined : encodingOrCallback;\n      const cb = typeof encodingOrCallback === 'function' ? encodingOrCallback : callback;\n\n      if (chunk) {\n        if (Buffer.isBuffer(chunk)) {\n          chunks.push(chunk);\n        } else if (typeof chunk === 'string') {\n          chunks.push(Buffer.from(chunk, encoding || 'utf-8'));\n        }\n      }\n\n      // Check content type\n      const contentType = res.getHeader('content-type');\n      isHtml = typeof contentType === 'string' && contentType.includes('text/html');\n\n      if (isHtml && chunks.length > 0) {\n        let html = Buffer.concat(chunks).toString('utf-8');\n\n        // Only inject if not already present\n        if (html.includes('</body>') && !html.includes('prototype-annotator-root')) {\n          const configScript = `<script>window.__PROTOTYPE_ANNOTATOR_CONFIG__=${JSON.stringify(clientConfig)};</script>`;\n          const overlayScript = `<script src=\"${basePath}/overlay.js\"></script>`;\n          html = html.replace('</body>', `${configScript}${overlayScript}</body>`);\n\n          // Update content length\n          res.setHeader('content-length', Buffer.byteLength(html));\n        }\n\n        // Restore and call original methods\n        res.write = originalWrite;\n        res.end = originalEnd;\n\n        return res.end(html, 'utf-8', cb);\n      }\n\n      // Not HTML, restore and send original chunks\n      res.write = originalWrite;\n      res.end = originalEnd;\n\n      if (chunks.length > 0) {\n        const body = Buffer.concat(chunks);\n        return res.end(body, cb);\n      }\n\n      return res.end(cb);\n    };\n\n    next();\n  };\n}\n","import type { Request, Response, NextFunction } from 'express';\n\nexport interface ApiError extends Error {\n  statusCode?: number;\n  code?: string;\n}\n\nexport function errorHandler(\n  err: ApiError,\n  _req: Request,\n  res: Response,\n  _next: NextFunction\n): void {\n  console.error('Prototype Annotator Error:', err);\n\n  const statusCode = err.statusCode || 500;\n  const message = err.message || 'Internal server error';\n\n  res.status(statusCode).json({\n    success: false,\n    error: message,\n    code: err.code,\n  });\n}\n\nexport function notFoundHandler(_req: Request, res: Response): void {\n  res.status(404).json({\n    success: false,\n    error: 'Not found',\n  });\n}\n","import { z } from 'zod';\nimport path from 'path';\nimport type { PrototypeAnnotatorConfig, ResolvedConfig, ActorMode } from '../types/index.js';\n\n// Zod schema for configuration validation\nexport const ConfigSchema = z.object({\n  basePath: z.string().default('/__prototype-annotator'),\n  dbPath: z.string().default('./prototype-annotator/annotator.sqlite'),\n  exportDir: z.string().default('./prototype_annotator_exports'),\n  defaultActor: z.string().default('anonymous'),\n  enableOverlay: z.boolean().default(true),\n  enableDashboard: z.boolean().default(true),\n  urlMode: z.enum(['full', 'canonical']).default('full'),\n  actorMode: z.enum(['prompt', 'anonymous', 'fixed']).default('prompt'),\n});\n\nexport function resolveConfig(input?: PrototypeAnnotatorConfig): ResolvedConfig {\n  const parsed = ConfigSchema.parse(input ?? {});\n\n  // Ensure basePath starts with / and has no trailing slash\n  let basePath = parsed.basePath;\n  if (!basePath.startsWith('/')) {\n    basePath = '/' + basePath;\n  }\n  basePath = basePath.replace(/\\/+$/, '');\n\n  // Resolve paths relative to cwd\n  const dbPath = path.isAbsolute(parsed.dbPath)\n    ? parsed.dbPath\n    : path.resolve(process.cwd(), parsed.dbPath);\n\n  const exportDir = path.isAbsolute(parsed.exportDir)\n    ? parsed.exportDir\n    : path.resolve(process.cwd(), parsed.exportDir);\n\n  return {\n    basePath,\n    dbPath,\n    exportDir,\n    defaultActor: parsed.defaultActor,\n    enableOverlay: parsed.enableOverlay,\n    enableDashboard: parsed.enableDashboard,\n    urlMode: parsed.urlMode,\n    actorMode: parsed.actorMode as ActorMode,\n  };\n}\n\nexport function getClientConfig(config: ResolvedConfig): {\n  basePath: string;\n  apiUrl: string;\n  defaultActor: string;\n  actorMode: ActorMode;\n} {\n  return {\n    basePath: config.basePath,\n    apiUrl: `${config.basePath}/api`,\n    defaultActor: config.defaultActor,\n    actorMode: config.actorMode,\n  };\n}\n","import { Router, json, static as expressStatic, Request, Response } from 'express';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { initDatabaseAsync } from '../db/index.js';\nimport { createApiRouter } from '../api/router.js';\nimport { createInjector } from './injector.js';\nimport { errorHandler, notFoundHandler } from './error-handler.js';\nimport { resolveConfig, getClientConfig } from '../config/index.js';\nimport type { PrototypeAnnotatorConfig, PrototypeAnnotatorMiddleware } from '../types/index.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// Resolve client dist path - works both in development and when installed as dependency\nfunction getClientDistPath(): string {\n  // In the built package, __dirname is dist/, so client/dist is at ../client/dist\n  // But we need to handle both:\n  // 1. Development: src/middleware/factory.ts -> ../../client/dist\n  // 2. Installed: node_modules/prototype-annotator/dist/index.js -> ../client/dist\n\n  // Try the installed package path first (dist/ -> client/dist)\n  const installedPath = path.resolve(__dirname, '../client/dist');\n  const devPath = path.resolve(__dirname, '../../client/dist');\n\n  // Check if we're in a bundled dist folder\n  if (__dirname.endsWith('dist') || __dirname.includes('dist/')) {\n    return installedPath;\n  }\n\n  return devPath;\n}\n\nexport async function createPrototypeAnnotator(\n  userConfig?: PrototypeAnnotatorConfig\n): Promise<PrototypeAnnotatorMiddleware> {\n  // Resolve configuration\n  const config = resolveConfig(userConfig);\n\n  // Initialize database (async for sql.js)\n  await initDatabaseAsync(config.dbPath);\n\n  // Create main router for API and static files\n  const router = Router();\n\n  // JSON body parser for API routes\n  router.use(json());\n\n  // Client config for injection\n  const clientConfig = getClientConfig(config);\n\n  // Mount API router\n  router.use(`${config.basePath}/api`, createApiRouter(config));\n\n  // Serve static files for overlay and dashboard\n  const clientDistPath = getClientDistPath();\n\n  // Serve overlay.js using sendFile (not express.static which expects a directory)\n  router.get(`${config.basePath}/overlay.js`, (_req: Request, res: Response) => {\n    res.sendFile(path.join(clientDistPath, 'overlay.js'));\n  });\n\n  // Serve overlay.js.map for debugging\n  router.get(`${config.basePath}/overlay.js.map`, (_req: Request, res: Response) => {\n    res.sendFile(path.join(clientDistPath, 'overlay.js.map'));\n  });\n\n  // Serve dashboard if enabled\n  if (config.enableDashboard) {\n    // Serve dashboard static assets\n    router.use(\n      `${config.basePath}/dashboard`,\n      expressStatic(path.join(clientDistPath, 'dashboard'))\n    );\n\n    // SPA fallback for dashboard routes\n    router.get(`${config.basePath}/dashboard/*`, (_req: Request, res: Response) => {\n      res.sendFile(path.join(clientDistPath, 'dashboard', 'index.html'));\n    });\n  }\n\n  // Error handlers for API routes\n  router.use(`${config.basePath}/api`, notFoundHandler);\n  router.use(`${config.basePath}/api`, errorHandler);\n\n  // Create injector middleware for HTML responses (if overlay enabled)\n  const injector = config.enableOverlay\n    ? createInjector(config.basePath, clientConfig)\n    : null;\n\n  // Create combined middleware (for backwards compatibility)\n  const combinedMiddleware = Router();\n\n  // HTML injection needs to run before other middleware\n  if (injector) {\n    combinedMiddleware.use(injector);\n  }\n\n  // Mount the main router\n  combinedMiddleware.use(router);\n\n  // Create a passthrough middleware if no injector\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const injectorMiddleware = injector || ((_req: any, _res: any, next: () => void) => next());\n\n  // Return middleware object with separate router and injector\n  return {\n    middleware: () => combinedMiddleware,\n    router,  // Just API routes and static files (no injection)\n    injector: injectorMiddleware,\n    config,\n  };\n}\n"]}